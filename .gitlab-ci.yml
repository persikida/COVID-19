stages:
  - build
  - image

build statg:
  stage: build
  image: registry.services.mts.ru/docker/nginx/nginx-alpine:1.17.2
  before_script:
    - mkdir -p /build
    - mkdir -p /build/www-data/
  only:
    changes:
      - www/*
      - .gitlab-ci.yml
    refs:
      - test-branch
      - develop
  script:
    - cp -a $CI_PROJECT_DIR/www/* /www-data/
  artifacts:
    paths:
    - $CI_PROJECT_DIR/build
    expire_in: 1 day

image statg:
  stage: image
  image: registry.services.mts.ru/docker-ingame/kaniko:debug-v0.14.0
  only:
    refs:
      - test-branch
      - develop
  before_script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  script:
    - executor --context $CI_PROJECT_DIR/image/ --dockerfile $CI_PROJECT_DIR/image/dockerfile --destination $CI_REGISTRY_IMAGE:statgames-$CI_COMMIT_REF_NAME-commit-$CI_COMMIT_SHORT_SHA
  dependencies:
    - build statg