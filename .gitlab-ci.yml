stages:
  - image
  - deploy
  - undo

image statgames:
  stage: image
  image: registry.services.mts.ru/docker-ingame/kaniko:debug-v0.14.0
  only:
    refs:
      - test-branch
      - develop
  before_script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  script:
    - executor --context $CI_PROJECT_DIR/ --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE:statgames-$CI_COMMIT_REF_NAME-commit-$CI_COMMIT_SHORT_SHA

deploy statgames:
  stage: deploy
  image: lachlanevenson/k8s-kubectl:latest
  extends: .deploy_dev
  environment:
    name: statgames
  stage: deploy
  when: on_success
  only:
    refs:
      - test-build
      - develop
  except:
    changes:
      - '*.md'
      - .gitlab-ci.yml
  script:
    - kubectl --record deployment.apps/statgames set image deployment.v1.apps/statgames statgames=$CI_REGISTRY_IMAGE:statgames-$CI_COMMIT_REF_NAME-commit-$CI_COMMIT_SHORT_SHA -n development
    - kubectl -n development delete $(kubectl -n development get pod -o name -l app=statgames | grep statgames)

undo statgames:
  stage: undo
  image: lachlanevenson/k8s-kubectl:latest
  extends: .deploy_dev
  stage: undo
  when: manual
  only:
    refs:
      - test-branch
      - develop
  except:
    changes:
      - '*.md'
      - .gitlab-ci.yml
  script:
    - kubectl rollout undo deployment.apps/statgames -n development

.deploy_dev:
  variables:
    KUBECONFIG: /etc/deploy/config
  before_script:
    - mkdir -p /etc/deploy
    - echo ${KUBE_CONFIG_DEV} | base64 -d > ${KUBECONFIG}
